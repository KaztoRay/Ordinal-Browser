# =============================================================================
# OrdinalV8 v1.2.0 â€” ë©€í‹° í”Œë«í¼ ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì›Œí¬í”Œë¡œìš°
# v* íƒœê·¸ í‘¸ì‹œ ì‹œ 5ê°œ í”Œë«í¼ ë™ì‹œ ë¹Œë“œ â†’ GitHub Release ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
# =============================================================================
name: Build & Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ë¦´ë¦¬ì¦ˆ íƒœê·¸ (ì˜ˆ: v1.1.0)'
        required: false
        default: ''

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  QT_VERSION: '6.7.0'
  V8_VERSION: '12.4'
  CMAKE_BUILD_TYPE: Release
  ORDINAL_VERSION: ${{ github.ref_name }}

permissions:
  contents: write

jobs:
  # ===========================================================================
  # macOS ARM64 (Apple Silicon)
  # ===========================================================================
  build-macos-arm64:
    name: ğŸ macOS ARM64
    runs-on: macos-14
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Qt6 + WebEngine ì„¤ì¹˜
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true

      - name: ğŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„±
        run: |
          brew install cmake ninja openssl@3
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ğŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ğŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)
        continue-on-error: true

      - name: ğŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinalv8.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: packaging/macos/ordinalv8-*-arm64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # macOS x64 (Intel)
  # ===========================================================================
  build-macos-x64:
    name: ğŸ macOS x64
    runs-on: macos-14
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Qt6 + WebEngine ì„¤ì¹˜
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true

      - name: ğŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„±
        run: |
          brew install cmake ninja openssl@3
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ğŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ğŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)
        continue-on-error: true

      - name: ğŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinalv8.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch x64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64
          path: packaging/macos/ordinalv8-*-x64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # Windows x64
  # ===========================================================================
  build-windows-x64:
    name: ğŸªŸ Windows x64
    runs-on: windows-latest
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ MSVC í™˜ê²½
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: ğŸ“¦ Qt6 + WebEngine ì„¤ì¹˜
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2022_64
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true

      - name: ğŸ”¨ CMake êµ¬ì„±
        shell: cmd
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=%CMAKE_BUILD_TYPE% ^
            -DCMAKE_PREFIX_PATH=%Qt6_DIR% ^
            -DCMAKE_INSTALL_PREFIX=install

      - name: ğŸ—ï¸ ë¹Œë“œ
        shell: cmd
        run: cmake --build build --config %CMAKE_BUILD_TYPE% --parallel %NUMBER_OF_PROCESSORS%
        continue-on-error: true

      - name: ğŸ“‹ windeployqt
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path build/Release -Filter "ordinalv8.exe" -Recurse | Select-Object -First 1
          if ($exe) { windeployqt --release --no-translations --no-opengl-sw $exe.FullName }

      - name: ğŸ“¦ NSIS ì„¤ì¹˜ íŒŒì¼
        shell: pwsh
        run: |
          choco install nsis -y
          New-Item -ItemType Directory -Force -Path packaging/windows/dist
          Copy-Item -Recurse build/Release/* packaging/windows/dist/
          if (Test-Path "third_party/v8/lib") {
            Copy-Item third_party/v8/lib/*.dll packaging/windows/dist/ -ErrorAction SilentlyContinue
          }
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DARCH=x64 /DVERSION=${{ env.ORDINAL_VERSION }} packaging/windows/installer.nsi

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: packaging/windows/ordinalv8-*-x64-setup.exe
          if-no-files-found: warn

  # ===========================================================================
  # Linux x64
  # ===========================================================================
  build-linux-x64:
    name: ğŸ§ Linux x64
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Qt6 + WebEngine ì„¤ì¹˜
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: gcc_64
          modules: 'qtwebengine qtwebchannel qtpositioning'
          cache: true

      - name: ğŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„±
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            libssl-dev libcurl4-openssl-dev \
            fuse libfuse2 dpkg-dev debhelper \
            desktop-file-utils appstream \
            libnss3-dev libxcomposite-dev libxdamage-dev \
            libxrandr-dev libxtst-dev libasound2-dev

      - name: ğŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: ğŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc)
        continue-on-error: true

      - name: ğŸ“¦ .deb íŒ¨í‚¤ì§€
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch amd64

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: packaging/linux/ordinalv8-*-amd64.deb
          if-no-files-found: warn

  # ===========================================================================
  # Linux ARM64
  # ===========================================================================
  build-linux-arm64:
    name: ğŸ§ Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„± + QEMU
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            crossbuild-essential-arm64 \
            dpkg-dev debhelper qemu-user-static \
            libssl-dev:arm64 libcurl4-openssl-dev:arm64 || true
          # Add arm64 architecture for apt
          sudo dpkg --add-architecture arm64
          sudo apt-get update || true

      - name: ğŸ“¦ Qt6 (ARM64)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: linux_gcc_arm64
          cache: true
        continue-on-error: true

      - name: ğŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (Linux ARM64)
        run: |
          mkdir -p third_party/v8
          curl -fsSL "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-linux-arm64.tar.gz" \
            -o v8.tar.gz && tar xzf v8.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"

      - name: ğŸ”¨ CMake êµ¬ì„± (í¬ë¡œìŠ¤ ì»´íŒŒì¼)
        run: |
          cat > toolchain-aarch64.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          EOF

          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_TOOLCHAIN_FILE=toolchain-aarch64.cmake \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=/usr \
            || echo "âš ï¸ CMake êµ¬ì„± ì‹¤íŒ¨ â€” ìŠ¤í‚µ"
        continue-on-error: true

      - name: ğŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc) || echo "âš ï¸ ë¹Œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"
        continue-on-error: true

      - name: ğŸ“¦ .deb íŒ¨í‚¤ì§€ (ARM64)
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64

      - name: ğŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: packaging/linux/ordinalv8-*-arm64.deb
          if-no-files-found: warn

  # ===========================================================================
  # ë¦´ë¦¬ì¦ˆ â€” ëª¨ë“  ë¹Œë“œ ì™„ë£Œ í›„ GitHub Release + ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
  # ===========================================================================
  release:
    name: ğŸš€ GitHub Release
    needs:
      - build-macos-arm64
      - build-macos-x64
      - build-windows-x64
      - build-linux-x64
      - build-linux-arm64
    runs-on: ubuntu-latest
    if: always() && startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¥ ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ğŸ“‹ ì•„í‹°íŒ©íŠ¸ ëª©ë¡
        run: find artifacts/ -type f | sort

      - name: ğŸš€ ë¦´ë¦¬ì¦ˆ ìƒì„± + ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "OrdinalV8 ${{ github.ref_name }}"
          body: |
            # OrdinalV8 ${{ github.ref_name }} ğŸš€

            V8 ì—”ì§„ ê¸°ë°˜ ë³´ì•ˆ ë¸Œë¼ìš°ì € + LLM Security Agent

            ## ğŸ†• v1.2.0 ìƒˆ ê¸°ëŠ¥

            ### ğŸ§© ì½”ì–´ ì—”ì§„ ê°•í™”
            - **íƒ­ ë§¤ë‹ˆì €** â€” íƒ­ ê·¸ë£¹, í•€/ë®¤íŠ¸, ìë™ ìˆ˜ë©´, ë‹«íŒ íƒ­ ë³µì›, ìœˆë„ìš° ê°„ ë“œë˜ê·¸
            - **í¼í¬ë¨¼ìŠ¤ ëª¨ë‹ˆí„°** â€” íƒ­ë³„ CPU/ë©”ëª¨ë¦¬ ì¶”ì , í”„ë ˆì„ íƒ€ì´ë°, ë©”ëª¨ë¦¬ ì••ë ¥ ê°ì§€
            - **ë¯¸ë””ì–´ ì»¨íŠ¸ë¡¤ëŸ¬** â€” ì „ì—­ ì¬ìƒ ì œì–´, PiP, AirPlay/Chromecast ìºìŠ¤íŒ…

            ### ğŸŒ ë„¤íŠ¸ì›Œí¬ ê°•í™”
            - **DNS-over-HTTPS** ë¦¬ì¡¸ë²„, SOCKS5 í”„ë¡ì‹œ, PAC ìŠ¤í¬ë¦½íŠ¸
            - **ë‹¤ìš´ë¡œë“œ ê°€ì†ê¸°** â€” 8ë³‘ë ¬ ì„¸ê·¸ë¨¼íŠ¸, ì´ì–´ë°›ê¸°, ëŒ€ì—­í­ ê´€ë¦¬

            ### ğŸ“– ë¦¬ë” ëª¨ë“œ
            - ì•„í‹°í´ ìë™ ì¶”ì¶œ, 4í…Œë§ˆ, TTS ì—°ë™, ì¸ì‡„ ì§€ì›

            ### ğŸ”’ í”„ë¼ì´ë²„ì‹œ ê°•í™”
            - **ì¿ í‚¤ ë™ì˜ ìë™ ê±°ë¶€** â€” 10ê°œ CMP ìë™ ê°ì§€ (CookieBot, OneTrust ë“±)
            - **WebRTC IP ìœ ì¶œ ë°©ì§€** â€” 5ë‹¨ê³„ ì •ì±…, STUN ì°¨ë‹¨, ICE í•„í„°ë§

            ## ğŸ“¦ ì„¤ì¹˜ íŒŒì¼
            | OS | Arch | File |
            |---|---|---|
            | macOS | ARM64 | .dmg |
            | macOS | x64 | .dmg |
            | Windows | x64 | .exe |
            | Linux | x64 | .deb |
            | Linux | ARM64 | .deb |

            > âš ï¸ V8 í”„ë¦¬ë¹ŒíŠ¸ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¯¸í™•ë³´ë¡œ ì¼ë¶€ í”Œë«í¼ ë°”ì´ë„ˆë¦¬ê°€ ëˆ„ë½ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

            ## ğŸ“Š í”„ë¡œì íŠ¸ í†µê³„
            - 155+ íŒŒì¼, 58,000+ ì¤„
            - C++20 + Qt6 + V8 + Python 3.12
            - ì „ì²´ ë³€ê²½ ì´ë ¥: [CHANGELOG.md](https://github.com/KaztoRay/OrdinalV8/blob/master/CHANGELOG.md)
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
