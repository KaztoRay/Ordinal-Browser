# =============================================================================
# Ordinal Browser â€” ë©€í‹° í”Œëž«í¼ ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì›Œí¬í”Œë¡œìš°
# íƒœê·¸ í‘¸ì‹œ(v*) ë˜ëŠ” ìˆ˜ë™ ì‹¤í–‰ ì‹œ 6ê°œ í”Œëž«í¼/ì•„í‚¤í…ì²˜ ë™ì‹œ ë¹Œë“œ
# =============================================================================
name: Build & Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ë¦´ë¦¬ì¦ˆ íƒœê·¸ (ì˜ˆ: v1.0.0)'
        required: false
        default: ''

# ë™ì‹œ ì‹¤í–‰ ë°©ì§€ â€” ê°™ì€ íƒœê·¸ì— ëŒ€í•´ ì¤‘ë³µ ë¹Œë“œ ì°¨ë‹¨
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  QT_VERSION: '6.7.0'
  V8_VERSION: '12.4'
  CMAKE_BUILD_TYPE: Release
  ORDINAL_VERSION: ${{ github.ref_name }}

permissions:
  contents: write

jobs:
  # ===========================================================================
  # Windows x64 ë¹Œë“œ â€” MSVC + Qt6 + V8 + NSIS ì„¤ì¹˜ íŒŒì¼
  # ===========================================================================
  build-windows-x64:
    name: ðŸªŸ Windows x64
    runs-on: windows-latest
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ MSVC ê°œë°œ í™˜ê²½ ì„¤ì •
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: ðŸ“¦ Qt6 ì„¤ì¹˜
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: 'qtnetworkauth qtwebsockets'
          cache: true

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ
        shell: pwsh
        run: |
          # V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ë¥¼ GitHub Releasesì—ì„œ ë‹¤ìš´ë¡œë“œ
          $V8_URL = "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-win-x64.zip"
          New-Item -ItemType Directory -Force -Path third_party/v8
          try {
            Invoke-WebRequest -Uri $V8_URL -OutFile v8-win-x64.zip -TimeoutSec 120
            Expand-Archive -Path v8-win-x64.zip -DestinationPath third_party/v8 -Force
          } catch {
            Write-Warning "V8 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"
          }

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (vcpkg)
        shell: pwsh
        run: |
          # vcpkgë¡œ OpenSSL, curl, gRPC ì„¤ì¹˜
          vcpkg install openssl:x64-windows curl:x64-windows grpc:x64-windows protobuf:x64-windows
          echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} ^
            -DCMAKE_TOOLCHAIN_FILE=%CMAKE_TOOLCHAIN_FILE% ^
            -DCMAKE_PREFIX_PATH=%Qt6_DIR% ^
            -DV8_ROOT=third_party/v8 ^
            -DCMAKE_INSTALL_PREFIX=install
        shell: cmd

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} --parallel %NUMBER_OF_PROCESSORS%
        shell: cmd

      - name: ðŸ“‹ Qt6 DLL ë°°í¬ (windeployqt)
        shell: pwsh
        run: |
          # ë¹Œë“œëœ ì‹¤í–‰ íŒŒì¼ì— Qt6 DLL ë²ˆë“¤ë§
          $exe = Get-ChildItem -Path build/Release -Filter "ordinal-browser.exe" -Recurse | Select-Object -First 1
          if ($exe) {
            windeployqt --release --no-translations --no-opengl-sw $exe.FullName
          }

      - name: ðŸ“¦ NSIS ì„¤ì¹˜ íŒŒì¼ ìƒì„±
        shell: pwsh
        run: |
          # NSIS ì„¤ì¹˜
          choco install nsis -y
          # ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ë¥¼ íŒ¨í‚¤ì§• ë””ë ‰í† ë¦¬ë¡œ ë³µì‚¬
          New-Item -ItemType Directory -Force -Path packaging/windows/dist
          Copy-Item -Recurse build/Release/* packaging/windows/dist/
          # V8 ë°”ì´ë„ˆë¦¬ ë³µì‚¬ (ì¡´ìž¬í•˜ëŠ” ê²½ìš°)
          if (Test-Path "third_party/v8/lib") {
            Copy-Item third_party/v8/lib/*.dll packaging/windows/dist/ -ErrorAction SilentlyContinue
          }
          # NSIS ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DARCH=x64 /DVERSION=${{ env.ORDINAL_VERSION }} packaging/windows/installer.nsi

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-windows-x64-setup
          path: packaging/windows/ordinal-browser-*-x64-setup.exe
          if-no-files-found: warn

  # ===========================================================================
  # Windows ARM64 ë¹Œë“œ â€” í¬ë¡œìŠ¤ ì»´íŒŒì¼
  # ===========================================================================
  build-windows-arm64:
    name: ðŸªŸ Windows ARM64
    runs-on: windows-latest
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ MSVC ê°œë°œ í™˜ê²½ ì„¤ì • (ARM64 í¬ë¡œìŠ¤ ì»´íŒŒì¼)
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: amd64_arm64

      - name: ðŸ“¦ Qt6 ì„¤ì¹˜ (ARM64)
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_arm64
          modules: 'qtnetworkauth qtwebsockets'
          cache: true

      - name: ðŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜ (vcpkg ARM64)
        shell: pwsh
        run: |
          vcpkg install openssl:arm64-windows curl:arm64-windows
          echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (ARM64)
        shell: pwsh
        run: |
          $V8_URL = "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-win-arm64.zip"
          New-Item -ItemType Directory -Force -Path third_party/v8
          try {
            Invoke-WebRequest -Uri $V8_URL -OutFile v8-win-arm64.zip -TimeoutSec 120
            Expand-Archive -Path v8-win-arm64.zip -DestinationPath third_party/v8 -Force
          } catch {
            Write-Warning "V8 ARM64 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"
          }

      - name: ðŸ”¨ CMake êµ¬ì„± (ARM64 í¬ë¡œìŠ¤ ì»´íŒŒì¼)
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A ARM64 ^
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} ^
            -DCMAKE_TOOLCHAIN_FILE=%CMAKE_TOOLCHAIN_FILE% ^
            -DCMAKE_PREFIX_PATH=%Qt6_DIR% ^
            -DV8_ROOT=third_party/v8 ^
            -DCMAKE_INSTALL_PREFIX=install ^
            -DVCPKG_TARGET_TRIPLET=arm64-windows
        shell: cmd

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --config ${{ env.CMAKE_BUILD_TYPE }} --parallel %NUMBER_OF_PROCESSORS%
        shell: cmd

      - name: ðŸ“‹ Qt6 DLL ë°°í¬
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path build/Release -Filter "ordinal-browser.exe" -Recurse | Select-Object -First 1
          if ($exe) {
            windeployqt --release --no-translations --no-opengl-sw $exe.FullName
          }

      - name: ðŸ“¦ NSIS ì„¤ì¹˜ íŒŒì¼ ìƒì„± (ARM64)
        shell: pwsh
        run: |
          choco install nsis -y
          New-Item -ItemType Directory -Force -Path packaging/windows/dist
          Copy-Item -Recurse build/Release/* packaging/windows/dist/
          if (Test-Path "third_party/v8/lib") {
            Copy-Item third_party/v8/lib/*.dll packaging/windows/dist/ -ErrorAction SilentlyContinue
          }
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DARCH=arm64 /DVERSION=${{ env.ORDINAL_VERSION }} packaging/windows/installer.nsi

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-windows-arm64-setup
          path: packaging/windows/ordinal-browser-*-arm64-setup.exe
          if-no-files-found: warn

  # ===========================================================================
  # macOS ARM64 (Apple Silicon) ë¹Œë“œ
  # ===========================================================================
  build-macos-arm64:
    name: ðŸŽ macOS ARM64 (Apple Silicon)
    runs-on: macos-14
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Homebrew ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          brew install qt@6 openssl@3 curl grpc protobuf cmake ninja
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (macOS ARM64)
        run: |
          V8_URL="https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-macos-arm64.tar.gz"
          mkdir -p third_party/v8
          curl -fsSL "$V8_URL" -o v8-macos-arm64.tar.gz && \
            tar xzf v8-macos-arm64.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: ðŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinal-browser.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-macos-arm64
          path: packaging/macos/ordinal-browser-*-arm64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # macOS x64 (Intel) ë¹Œë“œ
  # ===========================================================================
  build-macos-x64:
    name: ðŸŽ macOS x64 (Intel)
    runs-on: macos-13
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Homebrew ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          brew install qt@6 openssl@3 curl grpc protobuf cmake ninja
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (macOS x64)
        run: |
          V8_URL="https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-macos-x64.tar.gz"
          mkdir -p third_party/v8
          curl -fsSL "$V8_URL" -o v8-macos-x64.tar.gz && \
            tar xzf v8-macos-x64.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: ðŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinal-browser.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch x64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-macos-x64
          path: packaging/macos/ordinal-browser-*-x64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # Linux x64 ë¹Œë“œ â€” .deb + AppImage
  # ===========================================================================
  build-linux-x64:
    name: ðŸ§ Linux x64
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            qt6-base-dev qt6-base-private-dev libqt6network6 \
            libqt6widgets6 libqt6gui6 libqt6core6 qt6-tools-dev \
            libssl-dev libcurl4-openssl-dev \
            libgrpc++-dev protobuf-compiler-grpc libprotobuf-dev \
            fuse libfuse2 \
            dpkg-dev debhelper \
            desktop-file-utils appstream

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (Linux x64)
        run: |
          V8_URL="https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-linux-x64.tar.gz"
          mkdir -p third_party/v8
          curl -fsSL "$V8_URL" -o v8-linux-x64.tar.gz && \
            tar xzf v8-linux-x64.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc)

      - name: ðŸ“¦ .deb íŒ¨í‚¤ì§€ ìƒì„±
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch amd64

      - name: ðŸ“¦ AppImage ìƒì„±
        run: |
          chmod +x packaging/linux/create_appimage.sh
          ./packaging/linux/create_appimage.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch x86_64

      - name: ðŸ“¤ .deb ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-linux-x64-deb
          path: packaging/linux/ordinal-browser-*-amd64.deb
          if-no-files-found: warn

      - name: ðŸ“¤ AppImage ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-linux-x64-appimage
          path: packaging/linux/ordinal-browser-*-x86_64.AppImage
          if-no-files-found: warn

  # ===========================================================================
  # Linux ARM64 ë¹Œë“œ â€” aarch64 í¬ë¡œìŠ¤ ì»´íŒŒì¼
  # ===========================================================================
  build-linux-arm64:
    name: ðŸ§ Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë„êµ¬ì²´ì¸ ì„¤ì¹˜
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            crossbuild-essential-arm64 \
            fuse libfuse2 \
            dpkg-dev debhelper \
            qemu-user-static

      - name: ðŸ“¦ ARM64 sysroot ë° Qt6 ì„¤ì¹˜
        run: |
          # ARM64 sysroot ìƒì„±
          sudo dpkg --add-architecture arm64
          # ARM64 ì†ŒìŠ¤ ì¶”ê°€ (Ubuntuì˜ ports ì•„ì¹´ì´ë¸Œ)
          echo "deb [arch=arm64] http://ports.ubuntu.com/ubuntu-ports $(lsb_release -cs) main restricted universe multiverse" | sudo tee /etc/apt/sources.list.d/arm64.list
          sudo apt-get update || true
          sudo apt-get install -y \
            libssl-dev:arm64 libcurl4-openssl-dev:arm64 || true

      - name: ðŸ“¦ Qt6 ì„¤ì¹˜ (ARM64 í¬ë¡œìŠ¤ ë¹Œë“œìš©)
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: gcc_arm64
          modules: 'qtnetworkauth qtwebsockets'
          cache: true

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ ë°”ì´ë„ˆë¦¬ ë‹¤ìš´ë¡œë“œ (Linux ARM64)
        run: |
          V8_URL="https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-linux-arm64.tar.gz"
          mkdir -p third_party/v8
          curl -fsSL "$V8_URL" -o v8-linux-arm64.tar.gz && \
            tar xzf v8-linux-arm64.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 í”„ë¦¬ë¹ŒíŠ¸ ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” V8 ì—†ì´ ë¹Œë“œ ì§„í–‰"

      - name: ðŸ”¨ CMake êµ¬ì„± (ARM64 í¬ë¡œìŠ¤ ì»´íŒŒì¼)
        run: |
          # í¬ë¡œìŠ¤ ì»´íŒŒì¼ íˆ´ì²´ì¸ íŒŒì¼ ìƒì„±
          cat > toolchain-aarch64.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          EOF

          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_TOOLCHAIN_FILE=toolchain-aarch64.cmake \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc)

      - name: ðŸ“¦ .deb íŒ¨í‚¤ì§€ ìƒì„± (ARM64)
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64

      - name: ðŸ“¦ AppImage ìƒì„± (ARM64)
        run: |
          chmod +x packaging/linux/create_appimage.sh
          ./packaging/linux/create_appimage.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch aarch64

      - name: ðŸ“¤ .deb ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-linux-arm64-deb
          path: packaging/linux/ordinal-browser-*-arm64.deb
          if-no-files-found: warn

      - name: ðŸ“¤ AppImage ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: ordinal-browser-linux-arm64-appimage
          path: packaging/linux/ordinal-browser-*-aarch64.AppImage
          if-no-files-found: warn

  # ===========================================================================
  # ë¦´ë¦¬ì¦ˆ â€” ëª¨ë“  ë¹Œë“œ ì™„ë£Œ í›„ GitHub Release ìƒì„± + ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
  # ===========================================================================
  release:
    name: ðŸš€ GitHub Release ìƒì„±
    needs:
      - build-windows-x64
      - build-windows-arm64
      - build-macos-arm64
      - build-macos-x64
      - build-linux-x64
      - build-linux-arm64
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: ðŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ ëª¨ë“  ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ“‹ ì•„í‹°íŒ©íŠ¸ ëª©ë¡ í™•ì¸
        run: |
          echo "=== ë‹¤ìš´ë¡œë“œëœ ì•„í‹°íŒ©íŠ¸ ==="
          find artifacts/ -type f | sort
          echo "=========================="

      - name: ðŸ“‹ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ìƒì„±
        run: |
          # CHANGELOG.mdì—ì„œ í˜„ìž¬ ë²„ì „ ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ ì¶”ì¶œ
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"

          cat > release_notes.md << 'NOTES'
          # Ordinal Browser ${{ github.ref_name }} ðŸš€

          ## V8 ê¸°ë°˜ ë³´ì•ˆ ë¸Œë¼ìš°ì € + LLM Security Agent

          ### ðŸ”’ ë³´ì•ˆ ê¸°ëŠ¥
          - í”¼ì‹± íƒì§€ (URL ë¶„ì„ + ì½˜í…ì¸  ë¶„ì„ + íƒ€ì´í¬ìŠ¤ì¿¼íŒ…)
          - XSS/Injection ê³µê²© íƒì§€
          - ì•…ì„± JavaScript ë¶„ì„ (V8 ê¸°ë°˜)
          - ê°œì¸ì •ë³´ ì¶”ì ê¸° ì°¨ë‹¨
          - SSL/TLS ì¸ì¦ì„œ ê²€ì¦

          ### ðŸ¤– AI ê¸°ëŠ¥
          - LLM ê¸°ë°˜ ë³´ì•ˆ ë¶„ì„ (GPT-4 + ë¡œì»¬ ëª¨ë¸ í´ë°±)
          - ì‹¤ì‹œê°„ ìœ„í˜‘ ìŠ¤íŠ¸ë¦¬ë°
          - íŽ˜ì´ì§€ ë³´ì•ˆ ë¦¬í¬íŠ¸ ìžë™ ìƒì„±

          ### ðŸŒ ë¸Œë¼ìš°ì € ê¸°ëŠ¥
          - V8 JavaScript ì—”ì§„
          - HTML5/CSS3 íŒŒì‹± + ë Œë”ë§
          - ë©€í‹°íƒ­ ë¸Œë¼ìš°ì§•
          - Qt6 ë„¤ì´í‹°ë¸Œ UI
          - ê°œë°œìž ë„êµ¬ (ì½˜ì†”, ë„¤íŠ¸ì›Œí¬, ë³´ì•ˆ ê°ì‚¬, DOM íŠ¸ë¦¬)

          ### ðŸ“¦ ì§€ì› í”Œëž«í¼
          | OS | Architecture | Format |
          |---|---|---|
          | Windows | x64 | .exe (NSIS) |
          | Windows | ARM64 | .exe (NSIS) |
          | macOS | Apple Silicon (arm64) | .dmg |
          | macOS | Intel (x64) | .dmg |
          | Linux | x64 | .deb, .AppImage |
          | Linux | ARM64 | .deb, .AppImage |

          ### ë¹Œë“œ ë°©ë²•
          ```bash
          ./scripts/setup.sh
          mkdir build && cd build
          cmake .. -DCMAKE_BUILD_TYPE=Release
          make -j$(nproc)
          ```

          ### ê¸°ìˆ  ìŠ¤íƒ
          - C++20, V8 Engine, Qt6, libcurl, OpenSSL, gRPC
          - Python 3.12, OpenAI API, PyTorch, Transformers
          NOTES

      - name: ðŸš€ GitHub Release ìƒì„± ë° ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Ordinal Browser ${{ github.ref_name }}"
          body_path: release_notes.md
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
            artifacts/**/*.AppImage
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
