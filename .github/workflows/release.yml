# =============================================================================
# Ordinal Browser v1.1.0 â€” ë©€í‹° í”Œëž«í¼ ë¹Œë“œ & ë¦´ë¦¬ì¦ˆ ì›Œí¬í”Œë¡œìš°
# v* íƒœê·¸ í‘¸ì‹œ ì‹œ 5ê°œ í”Œëž«í¼ ë™ì‹œ ë¹Œë“œ â†’ GitHub Release ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
# =============================================================================
name: Build & Release

on:
  push:
    tags: ['v*']
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'ë¦´ë¦¬ì¦ˆ íƒœê·¸ (ì˜ˆ: v1.1.0)'
        required: false
        default: ''

concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: true

env:
  QT_VERSION: '6.7.0'
  V8_VERSION: '12.4'
  CMAKE_BUILD_TYPE: Release
  ORDINAL_VERSION: ${{ github.ref_name }}

permissions:
  contents: write

jobs:
  # ===========================================================================
  # macOS ARM64 (Apple Silicon)
  # ===========================================================================
  build-macos-arm64:
    name: ðŸŽ macOS ARM64
    runs-on: macos-14
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Homebrew ì˜ì¡´ì„±
        run: |
          brew install qt@6 openssl@3 curl grpc protobuf cmake ninja
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (ARM64)
        run: |
          mkdir -p third_party/v8
          curl -fsSL "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-macos-arm64.tar.gz" \
            -o v8.tar.gz && tar xzf v8.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: ðŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinal-browser.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64
          path: packaging/macos/ordinal-browser-*-arm64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # macOS x64 (Intel)
  # ===========================================================================
  build-macos-x64:
    name: ðŸŽ macOS x64
    runs-on: macos-13
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ Homebrew ì˜ì¡´ì„±
        run: |
          brew install qt@6 openssl@3 curl grpc protobuf cmake ninja
          echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
          echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (x64)
        run: |
          mkdir -p third_party/v8
          curl -fsSL "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-macos-x64.tar.gz" \
            -o v8.tar.gz && tar xzf v8.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DOPENSSL_ROOT_DIR="$OPENSSL_ROOT_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=install

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(sysctl -n hw.ncpu)

      - name: ðŸ“¦ DMG ìƒì„±
        run: |
          chmod +x packaging/macos/create_dmg.sh
          ./packaging/macos/create_dmg.sh \
            --app-path build/ordinal-browser.app \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch x64 \
            --qt-dir "$Qt6_DIR/../.."

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: macos-x64
          path: packaging/macos/ordinal-browser-*-x64.dmg
          if-no-files-found: warn

  # ===========================================================================
  # Windows x64
  # ===========================================================================
  build-windows-x64:
    name: ðŸªŸ Windows x64
    runs-on: windows-latest
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ MSVC í™˜ê²½
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: ðŸ“¦ Qt6 ì„¤ì¹˜
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          modules: 'qtnetworkauth qtwebsockets'
          cache: true

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (Windows x64)
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Force -Path third_party/v8
          try {
            Invoke-WebRequest -Uri "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-win-x64.zip" `
              -OutFile v8.zip -TimeoutSec 120
            Expand-Archive -Path v8.zip -DestinationPath third_party/v8 -Force
          } catch {
            Write-Warning "V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"
          }

      - name: ðŸ“¦ vcpkg ì˜ì¡´ì„±
        shell: pwsh
        run: |
          vcpkg install openssl:x64-windows curl:x64-windows grpc:x64-windows protobuf:x64-windows
          echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV

      - name: ðŸ”¨ CMake êµ¬ì„±
        shell: cmd
        run: |
          cmake -B build -G "Visual Studio 17 2022" -A x64 ^
            -DCMAKE_BUILD_TYPE=%CMAKE_BUILD_TYPE% ^
            -DCMAKE_TOOLCHAIN_FILE=%CMAKE_TOOLCHAIN_FILE% ^
            -DCMAKE_PREFIX_PATH=%Qt6_DIR% ^
            -DV8_ROOT=third_party/v8 ^
            -DCMAKE_INSTALL_PREFIX=install

      - name: ðŸ—ï¸ ë¹Œë“œ
        shell: cmd
        run: cmake --build build --config %CMAKE_BUILD_TYPE% --parallel %NUMBER_OF_PROCESSORS%

      - name: ðŸ“‹ windeployqt
        shell: pwsh
        run: |
          $exe = Get-ChildItem -Path build/Release -Filter "ordinal-browser.exe" -Recurse | Select-Object -First 1
          if ($exe) { windeployqt --release --no-translations --no-opengl-sw $exe.FullName }

      - name: ðŸ“¦ NSIS ì„¤ì¹˜ íŒŒì¼
        shell: pwsh
        run: |
          choco install nsis -y
          New-Item -ItemType Directory -Force -Path packaging/windows/dist
          Copy-Item -Recurse build/Release/* packaging/windows/dist/
          if (Test-Path "third_party/v8/lib") {
            Copy-Item third_party/v8/lib/*.dll packaging/windows/dist/ -ErrorAction SilentlyContinue
          }
          & "C:\Program Files (x86)\NSIS\makensis.exe" /DARCH=x64 /DVERSION=${{ env.ORDINAL_VERSION }} packaging/windows/installer.nsi

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: windows-x64
          path: packaging/windows/ordinal-browser-*-x64-setup.exe
          if-no-files-found: warn

  # ===========================================================================
  # Linux x64
  # ===========================================================================
  build-linux-x64:
    name: ðŸ§ Linux x64
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ ì‹œìŠ¤í…œ ì˜ì¡´ì„±
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            qt6-base-dev qt6-base-private-dev libqt6network6 \
            libqt6widgets6 libqt6gui6 libqt6core6 qt6-tools-dev \
            libssl-dev libcurl4-openssl-dev \
            libgrpc++-dev protobuf-compiler-grpc libprotobuf-dev \
            fuse libfuse2 dpkg-dev debhelper \
            desktop-file-utils appstream

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (Linux x64)
        run: |
          mkdir -p third_party/v8
          curl -fsSL "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-linux-x64.tar.gz" \
            -o v8.tar.gz && tar xzf v8.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"

      - name: ðŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc)

      - name: ðŸ“¦ .deb íŒ¨í‚¤ì§€
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch amd64

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: linux-x64
          path: packaging/linux/ordinal-browser-*-amd64.deb
          if-no-files-found: warn

  # ===========================================================================
  # Linux ARM64
  # ===========================================================================
  build-linux-arm64:
    name: ðŸ§ Linux ARM64
    runs-on: ubuntu-latest
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¦ í¬ë¡œìŠ¤ ì»´íŒŒì¼ ë„êµ¬
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential cmake ninja-build \
            gcc-aarch64-linux-gnu g++-aarch64-linux-gnu \
            crossbuild-essential-arm64 \
            dpkg-dev debhelper qemu-user-static

      - name: ðŸ“¦ Qt6 (ARM64)
        uses: jurplel/install-qt-action@v3
        with:
          version: ${{ env.QT_VERSION }}
          host: linux
          target: desktop
          arch: gcc_arm64
          modules: 'qtnetworkauth qtwebsockets'
          cache: true

      - name: ðŸ“¦ V8 í”„ë¦¬ë¹ŒíŠ¸ (Linux ARM64)
        run: |
          mkdir -p third_party/v8
          curl -fsSL "https://github.com/nicedoc/aspect/releases/download/v8-${{ env.V8_VERSION }}/v8-linux-arm64.tar.gz" \
            -o v8.tar.gz && tar xzf v8.tar.gz -C third_party/v8 || \
            echo "âš ï¸ V8 ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨ â€” ìŠ¤í‚µ"

      - name: ðŸ”¨ CMake êµ¬ì„± (í¬ë¡œìŠ¤ ì»´íŒŒì¼)
        run: |
          cat > toolchain-aarch64.cmake << 'EOF'
          set(CMAKE_SYSTEM_NAME Linux)
          set(CMAKE_SYSTEM_PROCESSOR aarch64)
          set(CMAKE_C_COMPILER aarch64-linux-gnu-gcc)
          set(CMAKE_CXX_COMPILER aarch64-linux-gnu-g++)
          set(CMAKE_FIND_ROOT_PATH /usr/aarch64-linux-gnu)
          set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
          set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
          set(CMAKE_FIND_ROOT_PATH_MODE_PACKAGE ONLY)
          EOF

          cmake -B build -G Ninja \
            -DCMAKE_BUILD_TYPE=${{ env.CMAKE_BUILD_TYPE }} \
            -DCMAKE_TOOLCHAIN_FILE=toolchain-aarch64.cmake \
            -DCMAKE_PREFIX_PATH="$Qt6_DIR" \
            -DV8_ROOT=third_party/v8 \
            -DCMAKE_INSTALL_PREFIX=/usr

      - name: ðŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --parallel $(nproc)

      - name: ðŸ“¦ .deb íŒ¨í‚¤ì§€ (ARM64)
        run: |
          chmod +x packaging/linux/create_deb.sh
          ./packaging/linux/create_deb.sh \
            --build-dir build \
            --version "${{ env.ORDINAL_VERSION }}" \
            --arch arm64

      - name: ðŸ“¤ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: linux-arm64
          path: packaging/linux/ordinal-browser-*-arm64.deb
          if-no-files-found: warn

  # ===========================================================================
  # ë¦´ë¦¬ì¦ˆ â€” ëª¨ë“  ë¹Œë“œ ì™„ë£Œ í›„ GitHub Release + ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
  # ===========================================================================
  release:
    name: ðŸš€ GitHub Release
    needs:
      - build-macos-arm64
      - build-macos-x64
      - build-windows-x64
      - build-linux-x64
      - build-linux-arm64
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      - name: ðŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ“¥ ëª¨ë“  ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: ðŸ“‹ ì•„í‹°íŒ©íŠ¸ ëª©ë¡
        run: find artifacts/ -type f | sort

      - name: ðŸš€ ë¦´ë¦¬ì¦ˆ ìƒì„± + ì—…ë¡œë“œ
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: "Ordinal Browser ${{ github.ref_name }}"
          body: |
            # Ordinal Browser ${{ github.ref_name }} ðŸš€

            ## ìƒˆ ê¸°ëŠ¥

            ### ðŸ§© í™•ìž¥ í”„ë¡œê·¸ëž¨ ì‹œìŠ¤í…œ
            - Chrome í˜¸í™˜ ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸, V8 ìƒŒë“œë°•ì‹±, content script, ë©”ì‹œì§€ íŒ¨ì‹±, ìŠ¤í† ë¦¬ì§€ API

            ### ðŸ“š ë°ì´í„° ê´€ë¦¬
            - ë¶ë§ˆí¬ ê´€ë¦¬ìž, ížˆìŠ¤í† ë¦¬, ë‹¤ìš´ë¡œë“œ ê´€ë¦¬ìž, ì„¸ì…˜ ë³µêµ¬

            ### ðŸ”‘ í”„ë¼ì´ë²„ì‹œ
            - ë¹„ë°€ë²ˆí˜¸ ê´€ë¦¬ìž (AES-256-GCM), ì¿ í‚¤ ê´€ë¦¬ìž, ìžë™ìž…ë ¥

            ### ðŸ›¡ï¸ ê´‘ê³  ì°¨ë‹¨
            - EasyList/uBlock í˜¸í™˜ í•„í„° ì—”ì§„, CSS ìš”ì†Œ ìˆ¨ê¹€

            ### ðŸŽ¨ í…Œë§ˆ & ì„¤ì •
            - Light/Dark/System í…Œë§ˆ (Catppuccin íŒ”ë ˆíŠ¸)
            - 6íƒ­ ì„¤ì • í™”ë©´

            ### ðŸ¤– ì—ì´ì „íŠ¸ ê°•í™”
            - URL í‰íŒ (VT/GSB/PhishTank/URLhaus)
            - CSP/SRI/CORS ë¶„ì„
            - HTML ë³´ì•ˆ ë¦¬í¬íŠ¸ ìƒì„±
            - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„° (í¬ë¦½í† ë§ˆì´ë‹/DOMë³€ì´/ë°ì´í„°ìœ ì¶œ)

            ### ðŸ“¦ ì„¤ì¹˜ íŒŒì¼ (Actions ìžë™ ë¹Œë“œ)
            | OS | Arch | File |
            |---|---|---|
            | macOS | ARM64 | .dmg |
            | macOS | x64 | .dmg |
            | Windows | x64 | .exe |
            | Linux | x64 | .deb |
            | Linux | ARM64 | .deb |

            ### ðŸ“Š í”„ë¡œì íŠ¸ í†µê³„
            - 135+ íŒŒì¼, 55,000+ ì¤„
            - C++20 + Python 3.12
          draft: false
          prerelease: false
          files: |
            artifacts/**/*.exe
            artifacts/**/*.dmg
            artifacts/**/*.deb
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
