# =============================================================================
# Ordinal Browser â€” CI íŒŒì´í”„ë¼ì¸
# ëª¨ë“  push/PRì— ëŒ€í•´ ë¹Œë“œ, í…ŒìŠ¤íŠ¸, ë¦°íŒ… ìˆ˜í–‰
# =============================================================================
name: CI

on:
  push:
    branches: [master, develop, 'feature/**']
  pull_request:
    branches: [master, develop]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ===========================================================================
  # C++ ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸ â€” 3ê°œ í”Œë«í¼
  # ===========================================================================
  build-cpp:
    name: ğŸ”¨ C++ ë¹Œë“œ (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-14, windows-latest]
        include:
          - os: ubuntu-latest
            cmake_generator: Ninja
            install_cmd: |
              sudo apt-get update
              sudo apt-get install -y \
                build-essential cmake ninja-build \
                qt6-base-dev qt6-base-private-dev \
                libssl-dev libcurl4-openssl-dev \
                libgrpc++-dev protobuf-compiler-grpc libprotobuf-dev \
                libgtest-dev libgmock-dev
          - os: macos-14
            cmake_generator: Ninja
            install_cmd: |
              brew install qt@6 openssl@3 curl grpc protobuf cmake ninja googletest
              echo "Qt6_DIR=$(brew --prefix qt@6)/lib/cmake/Qt6" >> $GITHUB_ENV
              echo "OPENSSL_ROOT_DIR=$(brew --prefix openssl@3)" >> $GITHUB_ENV
          - os: windows-latest
            cmake_generator: "Visual Studio 17 2022"
            install_cmd: |
              vcpkg install openssl:x64-windows curl:x64-windows gtest:x64-windows
              echo "CMAKE_TOOLCHAIN_FILE=$env:VCPKG_INSTALLATION_ROOT/scripts/buildsystems/vcpkg.cmake" >> $env:GITHUB_ENV

    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ MSVC ì„¤ì • (Windows)
        if: runner.os == 'Windows'
        uses: ilammy/msvc-dev-cmd@v1
        with:
          arch: x64

      - name: ğŸ“¦ Qt6 ì„¤ì¹˜ (Windows)
        if: runner.os == 'Windows'
        uses: jurplel/install-qt-action@v3
        with:
          version: '6.7.0'
          host: windows
          target: desktop
          arch: win64_msvc2019_64
          cache: true

      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: ${{ matrix.install_cmd }}
        shell: ${{ runner.os == 'Windows' && 'pwsh' || 'bash' }}

      - name: ğŸ”¨ CMake êµ¬ì„±
        run: |
          cmake -B build -G "${{ matrix.cmake_generator }}" \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTING=ON
        shell: bash

      - name: ğŸ—ï¸ ë¹Œë“œ
        run: cmake --build build --config Debug --parallel 4

      - name: ğŸ§ª C++ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (GTest)
        run: |
          cd build
          ctest --output-on-failure --timeout 120 -C Debug
        shell: bash
        continue-on-error: true

  # ===========================================================================
  # Python í…ŒìŠ¤íŠ¸ â€” LLM Security Agent
  # ===========================================================================
  test-python:
    name: ğŸ Python í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python 3.12 ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: ğŸ“¦ Python ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          pip install -r agent/requirements.txt
          pip install pytest pytest-cov pytest-asyncio flake8 mypy black isort

      - name: ğŸ§ª pytest ì‹¤í–‰
        run: |
          python -m pytest tests/python/ \
            --tb=short \
            --cov=agent \
            --cov-report=term-missing \
            --cov-report=xml:coverage.xml \
            -v
        continue-on-error: true

      - name: ğŸ“Š ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-coverage
          path: coverage.xml

  # ===========================================================================
  # ë¦°íŒ… â€” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
  # ===========================================================================
  lint:
    name: ğŸ” ì½”ë“œ ë¦°íŒ…
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ“¥ ì†ŒìŠ¤ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: ğŸ“¦ ë¦°íŒ… ë„êµ¬ ì„¤ì¹˜
        run: |
          pip install flake8 black isort mypy
          sudo apt-get update
          sudo apt-get install -y cppcheck clang-format

      - name: ğŸ Python ë¦°íŒ… (flake8)
        run: |
          flake8 agent/ --max-line-length=120 --statistics --count
        continue-on-error: true

      - name: ğŸ Python í¬ë§¤íŒ… ê²€ì‚¬ (black)
        run: |
          black --check --diff agent/
        continue-on-error: true

      - name: ğŸ Python import ì •ë ¬ ê²€ì‚¬ (isort)
        run: |
          isort --check-only --diff agent/
        continue-on-error: true

      - name: ğŸ”§ C++ ì •ì  ë¶„ì„ (cppcheck)
        run: |
          cppcheck --enable=warning,style,performance,portability \
            --suppress=missingIncludeSystem \
            --error-exitcode=0 \
            --inline-suppr \
            -I src/ \
            src/
        continue-on-error: true

      - name: ğŸ”§ C++ í¬ë§¤íŒ… ê²€ì‚¬ (clang-format)
        run: |
          find src/ -name '*.cpp' -o -name '*.h' | \
            xargs clang-format --dry-run --Werror 2>&1 || true
        continue-on-error: true

  # ===========================================================================
  # CI ìƒíƒœ ìš”ì•½
  # ===========================================================================
  ci-status:
    name: âœ… CI ìƒíƒœ
    needs: [build-cpp, test-python, lint]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: ğŸ“‹ CI ê²°ê³¼ ìš”ì•½
        run: |
          echo "## CI ê²°ê³¼ ìš”ì•½" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| ì‘ì—… | ìƒíƒœ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| C++ ë¹Œë“œ | ${{ needs.build-cpp.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Python í…ŒìŠ¤íŠ¸ | ${{ needs.test-python.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ì½”ë“œ ë¦°íŒ… | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY

      - name: âŒ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬
        if: >-
          needs.build-cpp.result == 'failure' ||
          needs.test-python.result == 'failure'
        run: |
          echo "::error::CI íŒŒì´í”„ë¼ì¸ ì‹¤íŒ¨!"
          exit 1
