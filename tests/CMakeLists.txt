# ============================================================
# í…ŒìŠ¤íŠ¸ ë¹Œë“œ ì„¤ì • â€” Google Test ê¸°ë°˜ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
# ============================================================
# ì‚¬ìš©ë²•:
#   cmake -DBUILD_TESTS=ON .. && make -j$(nproc) && ctest --output-on-failure
#
# í…ŒìŠ¤íŠ¸ ì‹¤í–‰ íŒŒì¼:
#   - test_security  : ë³´ì•ˆ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ (15ê°œ ì¼€ì´ìŠ¤)
#   - test_rendering : ë Œë”ë§ ì—”ì§„ í…ŒìŠ¤íŠ¸ (16ê°œ ì¼€ì´ìŠ¤)
#   - test_network   : ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ í…ŒìŠ¤íŠ¸ (10ê°œ ì¼€ì´ìŠ¤)
# ============================================================

cmake_minimum_required(VERSION 3.20)

# ---- Google Test ì˜ì¡´ì„± ----
include(FetchContent)
FetchContent_Declare(
    googletest
    GIT_REPOSITORY https://github.com/google/googletest.git
    GIT_TAG        v1.14.0
    GIT_SHALLOW    TRUE
)
# Windowsì—ì„œ gtestê°€ ê³µìœ  ëŸ°íƒ€ì„ê³¼ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ ì„¤ì •
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

# Google Test ë§¤í¬ë¡œ í™œì„±í™”
include(GoogleTest)

# ---- ê³µí†µ ì„¤ì • ----
set(TEST_COMMON_INCLUDES
    ${CMAKE_SOURCE_DIR}/src
    ${CMAKE_SOURCE_DIR}/src/core
    ${CMAKE_SOURCE_DIR}/src/network
    ${CMAKE_SOURCE_DIR}/src/security
    ${CMAKE_SOURCE_DIR}/src/rendering
    ${CMAKE_SOURCE_DIR}/src/ui
)

# í”„ë¡œì íŠ¸ ì†ŒìŠ¤ íŒŒì¼ (í…ŒìŠ¤íŠ¸ ëŒ€ìƒ)
file(GLOB SECURITY_SOURCES
    ${CMAKE_SOURCE_DIR}/src/security/*.cpp
)
file(GLOB RENDERING_SOURCES
    ${CMAKE_SOURCE_DIR}/src/rendering/*.cpp
)
file(GLOB NETWORK_SOURCES
    ${CMAKE_SOURCE_DIR}/src/network/*.cpp
)

# ============================================================
# 1. ë³´ì•ˆ ëª¨ë“ˆ í…ŒìŠ¤íŠ¸ (15ê°œ ì¼€ì´ìŠ¤)
# ============================================================
add_executable(test_security
    test_security.cpp
    ${SECURITY_SOURCES}
)
target_include_directories(test_security PRIVATE ${TEST_COMMON_INCLUDES})
target_link_libraries(test_security PRIVATE
    GTest::gtest
    GTest::gtest_main
    GTest::gmock
)
target_compile_features(test_security PRIVATE cxx_std_20)
gtest_discover_tests(test_security
    PROPERTIES LABELS "security"
    DISCOVERY_TIMEOUT 30
)

# ============================================================
# 2. ë Œë”ë§ ì—”ì§„ í…ŒìŠ¤íŠ¸ (16ê°œ ì¼€ì´ìŠ¤)
# ============================================================
add_executable(test_rendering
    test_rendering.cpp
    ${RENDERING_SOURCES}
)
target_include_directories(test_rendering PRIVATE ${TEST_COMMON_INCLUDES})
target_link_libraries(test_rendering PRIVATE
    GTest::gtest
    GTest::gtest_main
    GTest::gmock
)
target_compile_features(test_rendering PRIVATE cxx_std_20)
gtest_discover_tests(test_rendering
    PROPERTIES LABELS "rendering"
    DISCOVERY_TIMEOUT 30
)

# ============================================================
# 3. ë„¤íŠ¸ì›Œí¬ ë ˆì´ì–´ í…ŒìŠ¤íŠ¸ (10ê°œ ì¼€ì´ìŠ¤)
# ============================================================
add_executable(test_network
    test_network.cpp
    ${NETWORK_SOURCES}
)
target_include_directories(test_network PRIVATE ${TEST_COMMON_INCLUDES})
target_link_libraries(test_network PRIVATE
    GTest::gtest
    GTest::gtest_main
    GTest::gmock
)
target_compile_features(test_network PRIVATE cxx_std_20)
gtest_discover_tests(test_network
    PROPERTIES LABELS "network"
    DISCOVERY_TIMEOUT 30
)

# ============================================================
# ì»¤ìŠ¤í…€ í…ŒìŠ¤íŠ¸ íƒ€ê²Ÿ â€” ì „ì²´ í…ŒìŠ¤íŠ¸ í•œ ë²ˆì— ì‹¤í–‰
# ============================================================
add_custom_target(run_all_tests
    COMMAND ${CMAKE_CTEST_COMMAND} --output-on-failure -j4
    DEPENDS test_security test_rendering test_network
    COMMENT "ğŸ§ª ì „ì²´ C++ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
)
